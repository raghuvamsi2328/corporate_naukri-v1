name: Deploy to Development Server

on:
  push:
    branches: [ main ]  # Change to your branch name (dev, develop, master, etc.)
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Server
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        SERVER_PORT: ${{ secrets.SERVER_PORT }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -p $SERVER_PORT -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null
        
        # Deploy via SSH
        ssh -p $SERVER_PORT -i ~/.ssh/id_ed25519 $SERVER_USER@$SERVER_HOST << 'EOF'
          set -e
          
          echo "ðŸ“¦ Navigating to project directory..."
          cd /opt/corporate-naukri/corporate_naukri-v1
          
          echo "ðŸ”„ Pulling latest code from GitHub..."
          git pull origin main
          
          echo "ðŸ³ Stopping existing containers..."
          docker-compose down
          
          echo "ðŸ—ï¸ Building and starting containers..."
          docker-compose up -d --build
          
          echo "ðŸ§¹ Cleaning up unused Docker resources..."
          docker system prune -f
          
          echo "âœ… Deployment completed successfully!"
          
          echo ""
          echo "ðŸ“Š Container status:"
          docker-compose ps
        EOF